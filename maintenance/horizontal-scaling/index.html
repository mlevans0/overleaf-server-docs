
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../s3-migration/">
      
      
        <link rel="next" href="../../guides/for-users/">
      
      
      <link rel="icon" href="../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.29">
    
    
      
        <title>Horizontal scaling - Overleaf Server Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.76a95c52.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


  
  
    
    
      
    
    
  
  
  <style>.md-tag.md-tag--server_pro{--md-tag-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 80v149.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0l133.5-133.5c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7H48C21.5 32 0 53.5 0 80zm112 32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z"/></svg>');}</style>

    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#requirements" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Overleaf Server Docs" class="md-header__button md-logo" aria-label="Overleaf Server Docs" data-md-component="logo">
      
  <img src="../../assets/overleaf-logo-white.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Overleaf Server Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Horizontal scaling
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/mlevans0/overleaf-server-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started/" class="md-tabs__link">
          
  
  Getting started

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../installation/using-the-toolkit/" class="md-tabs__link">
          
  
  Installation

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../configuration/overleaf-toolkit/" class="md-tabs__link">
          
  
  Configuration

        </a>
      </li>
    
  

    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../data-and-backups/" class="md-tabs__link">
          
  
  Maintenance

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/for-users/" class="md-tabs__link">
          
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../release-notes/Release-Notes-5.x.x/" class="md-tabs__link">
          
  
  Release notes

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Overleaf Server Docs" class="md-nav__button md-logo" aria-label="Overleaf Server Docs" data-md-component="logo">
      
  <img src="../../assets/overleaf-logo-white.svg" alt="logo">

    </a>
    Overleaf Server Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/mlevans0/overleaf-server-docs" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Home
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Planning for success
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/what-skills-do-i-need/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    What skills do I need?
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/hardware-requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hardware requirements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/software-requirements/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Software requirements
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/microservices/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overleaf microservices
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Installation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Installation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/using-the-toolkit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using the Overleaf Toolkit
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/post-installation-tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Post-installation tasks
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Overleaf Toolkit
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            Overleaf Toolkit
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/overleaf-toolkit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Files and locations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/toolkit-settings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Toolkit settings
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/branding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Branding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/tls-proxy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TLS Proxy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/email/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring email
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring S3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6" >
        
          
          <label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Server Pro
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            Server Pro
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/getting-server-pro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Server Pro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/sandboxed-compiles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sandboxed Compiles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/ldap/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LDAP/AD
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/saml2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SAML 2.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/templates-system/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Templates system
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/git-bridge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git integration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/adding-learn-pages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Adding Learn pages
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/environment-variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Environment variables
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/localization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Localization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Maintenance
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Maintenance
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data-and-backups/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data and Backups
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../email-migration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Email migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../docker-compose-to-toolkit-migration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Docker Compose to Toolkit migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../updating-mongodb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Updating MongoDB
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3-migration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    S3 migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Horizontal scaling
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Horizontal scaling
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#external-central-data-storage" class="md-nav__link">
    <span class="md-ellipsis">
      External, central data storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-balancer-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Load balancer requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-pro-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Server Pro configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrading-server-pro" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrading Server Pro
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/for-users/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    For users
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    For administrators
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            For administrators
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/user-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/project-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project management
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/doc-version-recovery/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Doc version recovery
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/full-project-history-migration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Full project history migration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2_5" >
        
          
          <label class="md-nav__link" for="__nav_6_2_5" id="__nav_6_2_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Troubleshooting
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_6_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2_5">
            <span class="md-nav__icon md-icon"></span>
            Troubleshooting
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/troubleshooting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gathering information
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/common-problems/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common problems
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Release notes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Release notes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes-5.x.x/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.x.x
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes-4.x.x/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.x.x
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes-3.x.x/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.x.x
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes-2.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2.x.x
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---1.0.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1.0.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.6.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.6.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.5.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.5.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.4.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.4.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.3.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.3.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.2.0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.2.0
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.1.3-and-0.1.4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.1.3 and 0.1.4
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../release-notes/Release-Notes---0.1.2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    0.1.2
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#external-central-data-storage" class="md-nav__link">
    <span class="md-ellipsis">
      External, central data storage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#load-balancer-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Load balancer requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-pro-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Server Pro configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hardware" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upgrading-server-pro" class="md-nav__link">
    <span class="md-ellipsis">
      Upgrading Server Pro
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
<nav class="md-tags" >
  
    
    
      
      
        
      
    
    
      <span class="md-tag md-tag-icon md-tag--server_pro">Server Pro</span>
    
  
</nav>


  
    <a href="https://github.com/mlevans0/overleaf-server-docs/edit/main/docs/maintenance/horizontal-scaling.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


  <h1>Horizontal scaling</h1>

<p>Starting with version 3.5.6 Server Pro supports horizontal scaling.</p>
<p>This document lists the technical requirements and provides guidelines for running Server Pro in more than one node.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Starting with Server CE/Server Pro <code>5.0.3</code> environment variables have been rebranded from <code>SHARELATEX_*</code> to <code>OVERLEAF_*</code>.</p>
<p>If you're using a <code>4.x</code> version (or earlier) please make sure the variables are prefix accordingly (e.g. <code>SHARELATEX_SITE_URL</code> instead of <code>OVERLEAF_SITE_URL</code>)</p>
</div>
<p>Setting up horizontal scaling requires a significant effort. We advise considering horizontal scaling only when reaching a certain scale.As an example, a Server Pro installation for 1,000 total users has been set up successfully using a single server provisioned with two 4-core processors and 32GB of system memory. See the <a href="/docs/getting-started/hardware-requirements.md">hardware requirements</a> documentation for recommendations.</p>
<p>A deployment of Server Pro with horizontal scaling involves a set of external components, such as a Load Balancer and an S3-compatible backend.</p>
<p>We can help troubleshoot errors in the Server Pro containers that might be the result of misconfiguration and provide general advice based on this document.</p>
<p>Resolving technical issues specific to your hardware/software to provide the external components are not covered by our support terms.</p>
<h2 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">&para;</a></h2>
<h3 id="external-central-data-storage">External, central data storage<a class="headerlink" href="#external-central-data-storage" title="Permanent link">&para;</a></h3>
<p>The data storage in Server Pro can be split into four data stores:</p>
<ul>
<li>
<p><strong>MongoDB</strong></p>
<p>Most of the data is persisted into MongoDB.</p>
<p>We support either a local instance or an external instance.</p>
</li>
<li>
<p><strong>Redis</strong></p>
<p>Redis stores temporary data, such as pending document updates before they are flushed to MongoDB.</p>
<p>Redis is used for communicating document updates between different services and notifying the editor about state changes in a given project.</p>
<p>Redis is used for storing the user sessions.</p>
<p>We support either a local instance or an external instance.</p>
</li>
<li>
<p><strong>Project files and History files</strong></p>
<p>Non-editable project files are stored outside of MongoDB.</p>
<p>The new project history system (Server Pro 3.5 onwards) stores the history outside MongoDB as well.</p>
<p>For small single instances we support either a local file system (which could be backed by a local SSD, NFS or EBS) or a <a href="https://github.com/overleaf/overleaf/wiki/S3">S3 compatible data storage system</a>.</p>
<p>For horizontal scaling, we only support S3 compatible data storage systems.</p>
<p>NFS/Amazon EFS/Amazon EBS are not supported for horizontal scaling. Please see the <a href="https://github.com/overleaf/overleaf/wiki/Hardware-Requirements#storage">wiki page on scaling storage in Server Pro</a> for more details.</p>
</li>
<li>
<p><strong>Ephemeral files</strong></p>
<p>LaTeX compiles need to run on fast, local disks for optimal performance.
The output of the compilation does not need to persisted or backed up.</p>
<p>Buffering of new file uploads and the creation of project zip files also
benefits from using a local disk.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>We strongly advise on using a local disk. Using any kind of networked disk (such as NFS or EBS) can result in unexpected compile errors and other performance issues.</p>
</div>
</li>
<li>
<p><strong>Git-bridge</strong></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Git-bridge is available in Server Pro starting with version 4.0.1.</p>
</div>
<p>The git-repositories are stored locally on disk.There are no replication options available. Git-bridge should be run as a singleton. For optimal performance we advise on using a local disk for git-bridge data. The git-bridge data disk should be backed up regularly.</p>
<p>For the data storage with horizontal scaling you need:</p>
<ul>
<li>a central MongoDB instance that is accessible from all Server Pro instances</li>
<li>a central Redis instance that is accessible from all Server Pro instances</li>
<li>a central S3 compatible backend for project and history files</li>
<li>a local disk on each instance for ephemeral files</li>
<li>a local disk on the instance that hosts the git-bridge container for git-bridge data</li>
</ul>
</li>
</ul>
<h3 id="load-balancer-requirements">Load balancer requirements<a class="headerlink" href="#load-balancer-requirements" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Persistent routing</strong>, e.g. using a cookie</p>
<p>This requirement stems from these components:</p>
<ul>
<li>
<p>The real-time editing capability in Server Pro uses websockets with a fallback to polling. Each editing session has local state on the server side and the requests of a given editing session always need to be routed to the same Server Pro instance. The collaboration feature uses redis pub/sub for sharing updates between multiple Server Pro instances.</p>
</li>
<li>
<p>The LaTeX compilation keeps the output and compile cache locally for optional performance. Upon issuing a compile request to one Server Pro instance, the following PDF/log download requests need to be routed to the same Server Pro instance.</p>
</li>
</ul>
</li>
<li>
<p><strong>Long request timeouts</strong> to support the compilation of large LaTeX documents</p>
</li>
<li>
<p><strong>Websocket support</strong> for optimal performance</p>
</li>
<li>
<p><strong>POST payload size of 50MB</strong></p>
</li>
<li>
<p><strong>Keep-alive timeout</strong> must be lower than the Server Pro keep-alive timeout</p>
<p>The keep-alive timeout in Server Pro can be configured using the environment variable <code>NGINX_KEEPALIVE_TIMEOUT</code>. The default value is 65s.</p>
<p>With the default, a keep-alive timeout of 60s in the load balancer works.</p>
<p>With <code>NGINX_KEEPALIVE_TIMEOUT=120</code>, the load balancer could pick 115s.</p>
</li>
<li>
<p><strong>Client IPs</strong></p>
<p>Set the request header <code>X-Forwarded-For</code> to the client IP.</p>
</li>
<li>
<p>When <strong>terminating SSL</strong></p>
<p>The load balancer needs to add the request header <code>X-Forwarded-Proto: https</code>.</p>
<p><details>
<summary>Sample HAProxy configuration</summary></p>
<p><div class="highlight"><pre><span></span><code>global
  group haproxy
  user haproxy

  # Verbose logging
  log stdout format raw local0 debug

defaults
  mode                    http
  option                  httpchk HEAD /status
  http-check              expect status 200
  default-server          check

  # Verbose logging
  log                     global
  option                  httplog

  # Reroute to a different backend if the sticky one is down
  option                  redispatch 1
  # These retries are for TCP connect errors, not on HTTP status 500 responses
  retries                 3

  # Sticky session for 24h of inactivity -- compile output is deleted after 24h
  cookie                  server-pro-ha insert maxidle 24h

  # Try to connect to any backend for 1min, then return 503
  timeout queue           1m
  # Give Server Pro instances 15s to startup
  timeout connect         15s

  # Abort requests from very slow clients (allow 1min of inactivity when reading a request)
  timeout client          1m

  # Allow slow compiles -- hard-coded limit in clsi is 10min
  timeout server          10m

  # Disconnect the editor after 23h -- 1h ahead of their last use yesterday
  timeout tunnel          23h

  # Note: The keepalive behavior in haproxy works great with the default keepalive setup in Server Pro.
  # Haproxy is cleaning up connections in the background and it will redispatch requests when needed.

listen server-pro-ha-http
  bind :80
  http-request redirect scheme https unless { ssl_fc }

listen server-pro-ha-https
  bind :443 ssl crt /etc/ssl/certs/ssl-key-and-certificate-bundle.pem

  # Tell the application that we are behind https
  http-request set-header X-Forwarded-Proto https

  # Tell the application the actual client ip
  option forwardfor

  # See https://hstspreload.org/#deployment-recommendations
  http-response set-header Strict-Transport-Security &quot;max-age=63072000; includeSubDomains; preload;&quot;

  # Route git traffic to the sibling container of the git-bridge
  use-server server-pro-ha-1 if { path_beg /git/ }

  # Debugging
  http-response add-header X-Served-By %s
  stats enable
  stats uri /haproxy

  server server-pro-ha-1 198.18.1.1:80 cookie server-pro-ha-1
  server server-pro-ha-2 198.18.1.2:80 cookie server-pro-ha-2
  server server-pro-ha-3 198.18.1.3:80 cookie server-pro-ha-3
</code></pre></div>
</details></p>
</li>
</ul>
<h3 id="server-pro-configuration">Server Pro configuration<a class="headerlink" href="#server-pro-configuration" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><strong>Secrets</strong></p>
<p>The Server Pro instances need to agree on shared secrets:</p>
<ul>
<li><code>WEB_API_PASSWORD</code> (web api auth)</li>
<li><code>STAGING_PASSWORD</code> and <code>V1_HISTORY_PASSWORD</code> same value (history auth)</li>
<li><code>CRYPTO_RANDOM</code> (for session cookie)</li>
<li><code>OT_JWT_AUTH_KEY</code> (history auth)</li>
</ul>
<p>All of these secrets need to be configured with their own unique value and shared between the instances.</p>
<p>When not configured and user requests get routed to different Server Pro instances, their request will fail authentication checks and they either get redirect to the login page frequently or their actions in the UI will fail in unexpected ways.</p>
<p>When not configured, Server Pro uses a new random value for each secret based on 32 random bytes from <code>/dev/urandom</code> (256 random bits).</p>
<details>
<p><div class="highlight"><pre><span></span><code># https://github.com/overleaf/overleaf/blob/45ca0f796c679103efd305ddbef28073c4a5de32/server-ce/init_scripts/00_regen_sharelatex_secrets.sh#L14
dd if=/dev/urandom bs=1 count=32 2&gt;/dev/null | base64 -w 0 | rev | cut -b 2- | rev | tr -d &#39;\n+/&#39;
</code></pre></div>
</details></p>
</li>
<li>
<p><strong>MongoDB</strong></p>
<p>Point <code>OVERLEAF_MONGO_URL</code> (<code>SHARELATEX_MONGO_URL</code> for versions <code>4.x</code> and earlier) at the central MongoDB instance.</p>
</li>
<li>
<p><strong>Redis</strong></p>
<p>Point <code>OVERLEAF_REDIS_HOST</code> (<code>SHARELATEX_REDIS_HOST</code> for versions <code>4.x</code> and earlier) and <code>REDIS_HOST</code> at the central redis instance.</p>
</li>
<li>
<p><strong>S3 compatible storage</strong> for project and history files</p>
<p>Please see the <a href="https://github.com/overleaf/overleaf/wiki/S3">documentation on S3</a> for details.</p>
</li>
<li>
<p><strong>Ephemeral files</strong></p>
<p>The default bind-mount of a local SSD to <code>/var/lib/overleaf</code> (<code>/var/lib/sharelatex</code> for versions <code>4.x</code> and earlier) will be sufficient. Be sure to point <code>SANDBOXED_COMPILES_HOST_DIR</code> at the mount point on the host.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>We strongly advise on using a local disk. Using any kind of networked disk (such as NFS or EBS) can result in unexpected compile errors and other performance issues.</p>
</div>
</li>
<li>
<p><strong>Proxy configuration</strong></p>
</li>
<li>
<p>Set <code>OVERLEAF_BEHIND_PROXY=true</code> (<code>SHARELATEX_BEHIND_PROXY</code> for versions <code>4.x</code> and earlier) for accurate client IPs.</p>
</li>
<li>
<p>Set <code>TRUSTED_PROXY_IPS</code> to the IP of the load balancer
    (Multiple CIDRs can be specified, separated with a comma).</p>
</li>
<li>
<p><strong>Git-bridge integration</strong></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Git-bridge is available in Server Pro starting with version 4.0.1.</p>
</div>
<p>The git-bridge container needs a sibling Server Pro container for handling incoming git requests. This sibling container can serve regular user traffic as well.In the sample configuration, the first instance acts as sibling container for git-bridge, but any instance could function as that really.</p>
<p>Why do we need to designate one Server Pro container as sibling for git-bridge? Server Pro hands out download URLs for the history service to git-bridge.  We need to configure these history URLs to be accessible from the git-bridge container.</p>
<p>Server Pro container config:</p>
<ul>
<li>Set <code>GIT_BRIDGE_ENABLED</code> to <code>'true'</code></li>
<li>Set <code>GIT_BRIDGE_HOST</code> to <code>&lt;git-bridge container name&gt;</code> e.g. <code>git-bridge</code></li>
<li>Set <code>GIT_BRIDGE_PORT</code> to <code>8000</code></li>
<li>
<p>Set <code>V1_HISTORY_URL</code> to <code>http://&lt;server-pro sibling container name&gt;:3100/api</code>.</p>
<p>Note: This is only necessary on the sibling container for the git-bridge container.
      The other instances can use a localhost URL, which is the default.</p>
</li>
</ul>
<p>Git-Bridge container config:</p>
<ul>
<li>Set <code>GIT_BRIDGE_API_BASE_URL</code> to <code>http://&lt;server-pro sibling container name&gt;/api/v0</code>, e.g. <code>http://server-pro-ha-1/api/v0</code></li>
<li>Set <code>GIT_BRIDGE_OAUTH2_SERVER</code> to <code>http://&lt;server-pro sibling container name&gt;</code>, e.g. <code>http://server-pro-ha-1</code></li>
<li>Set <code>GIT_BRIDGE_POSTBACK_BASE_URL</code> to <code>http://&lt;git-bridge container name&gt;:8000</code>, e.g. <code>http://git-bridge:8000</code></li>
<li>Set <code>GIT_BRIDGE_ROOT_DIR</code> to the bind-mounted git-bridge data disk, e.g. <code>/data/git-bridge</code></li>
</ul>
<p><details>
<summary>Sample docker-compose.yml configuration</summary></p>
<p>Note: The following configuration is showing a self-contained setup.
      For the demo to work, you need to provide a valid SSL key/certificate and adjust the <code>OVERLEAF_SITE_URL</code> (<code>SHARELATEX_SITE_URL</code> for versions <code>4.x</code> and earlier).
      For an actual setup, you must replace the dummy secrets with actual secrets as noted inline.
      For an actual setup, you need to move the individual containers onto dedicates nodes and adjust the IP addresses to your local network setup.</p>
<p><div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2.2&#39;</span>

<span class="c1"># Actual horizontal scaling setup: pick your own network and replace IPs in config.</span>
<span class="nt">networks</span><span class="p">:</span>
<span class="w">    </span><span class="nt">default</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ipam</span><span class="p">:</span>
<span class="w">            </span><span class="nt">config</span><span class="p">:</span>
<span class="w">                </span><span class="c1"># This subnet is part of a reserved subnet used for benchmarking</span>
<span class="w">                </span><span class="c1"># https://tools.ietf.org/html/rfc2544</span>
<span class="w">                </span><span class="c1"># The full subnet is 198.18.0.0/15</span>
<span class="w">                </span><span class="c1"># Use 198.18.0.0/24 for lb and dbs</span>
<span class="w">                </span><span class="c1"># Use 198.18.1.0/24 for server-pro</span>
<span class="w">                </span><span class="c1"># Use 198.18.0.128/25 for ephemeral container</span>
<span class="w">                </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">gateway</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.1</span>
<span class="w">                  </span><span class="nt">ip_range</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.128/25</span>
<span class="w">                  </span><span class="nt">subnet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.0/23</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run haproxy outside docker on a separate host.</span>
<span class="w">    </span><span class="nt">lb</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">haproxy:2.6</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lb</span>
<span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">        </span><span class="nt">logging</span><span class="p">:</span>
<span class="w">            </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<span class="w">            </span><span class="nt">options</span><span class="p">:</span>
<span class="w">                </span><span class="nt">max-size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10g</span>
<span class="w">                </span><span class="nt">max-file</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;100&#39;</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./haproxy.conf:/usr/local/etc/haproxy/haproxy.cfg</span>
<span class="w">            </span><span class="c1"># $ cat certificate.pem key.pem &gt; ssl-key-and-certificate-bundle.pem</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ssl-key-and-certificate-bundle.pem:/etc/ssl/certs/ssl-key-and-certificate-bundle.pem</span>
<span class="w">        </span><span class="c1"># Alternative to &quot;ports&quot;: use host network to avoid docker-proxy overhead</span>
<span class="w">        </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>

<span class="w">        </span><span class="c1"># Alternative to &quot;network_mode: host&quot;: use docker-proxy for network isolation</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;80:80&quot;</span>
<span class="w">        </span><span class="c1">#     - &quot;443:443&quot;</span>
<span class="w">        </span><span class="c1"># networks:</span>
<span class="w">        </span><span class="c1">#     default:</span>
<span class="w">        </span><span class="c1">#         ipv4_address: 198.18.0.2</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: remove these as they run on other hosts.</span>
<span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">            </span><span class="nt">server-pro-ha-1</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_started</span>
<span class="w">            </span><span class="nt">server-pro-ha-2</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_started</span>
<span class="w">            </span><span class="nt">server-pro-ha-3</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_started</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container next to server-pro-ha-1.</span>
<span class="w">    </span><span class="c1"># For Server Pro 4.1 onwards.</span>
<span class="w">    </span><span class="nt">git-bridge</span><span class="p">:</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">        </span><span class="c1"># The tag should match the `server-pro-ha-1` container tag.</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/sharelatex/git-bridge:4.0.1</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: point /data/git-bridge at a dedicated local ssd.</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/git_bridge_data:/data/git-bridge</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git-bridge</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_API_BASE_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://server-pro-ha-1/api/v0&quot;</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_OAUTH2_SERVER</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://server-pro-ha-1&quot;</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_POSTBACK_BASE_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://git-bridge:8000&quot;</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_ROOT_DIR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/data/git-bridge&quot;</span>
<span class="w">        </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">root</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;/server-pro-start.sh&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.6</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container on a separate host.</span>
<span class="w">    </span><span class="nt">server-pro-ha-1</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;server-pro-ha-config</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">quay.io/sharelatex/sharelatex-pro:4.0.1</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-pro-ha-1</span>
<span class="w">        </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-pro-ha-1</span>
<span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: keep this entry.</span>
<span class="w">            </span><span class="nt">git-bridge</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_started</span>

<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: remove the ones below as they run on other hosts.</span>
<span class="w">            </span><span class="nt">mongo</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
<span class="w">            </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_started</span>
<span class="w">            </span><span class="nt">minio</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_started</span>
<span class="w">            </span><span class="nt">mongo_replica_set_setup</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_completed_successfully</span>
<span class="w">            </span><span class="nt">minio_setup</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_completed_successfully</span>
<span class="w">        </span><span class="nt">stop_grace_period</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60s</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/scratch-disk1:/var/lib/sharelatex</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span><span class="w"> </span><span class="nl">&amp;server-pro-ha-environment</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: provide your own domain/app name.</span>
<span class="w">            </span><span class="nt">OVERLEAF_SITE_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;https://overleaf.example.com&#39;</span>
<span class="w">            </span><span class="nt">OVERLEAF_APP_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Server Pro Horizontal Scaling Demo</span>

<span class="w">            </span><span class="nt">OVERLEAF_MONGO_URL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb://198.18.0.3/sharelatex</span>
<span class="w">            </span><span class="nt">OVERLEAF_REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.4</span>
<span class="w">            </span><span class="nt">REDIS_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.4</span>

<span class="w">            </span><span class="nt">ENABLED_LINKED_FILE_TYPES</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;project_file,project_output_file&#39;</span>
<span class="w">            </span><span class="nt">EMAIL_CONFIRMATION_DISABLED</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>

<span class="w">            </span><span class="nt">SANDBOXED_COMPILES</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="w">            </span><span class="nt">SANDBOXED_COMPILES_SIBLING_CONTAINERS</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="w">            </span><span class="nt">SANDBOXED_COMPILES_HOST_DIR</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/tmp/scratch-disk1/data/compiles&#39;</span>

<span class="w">            </span><span class="c1"># S3</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: pick secure credentials.</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_BACKEND</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_USER_FILES_BUCKET_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overleaf-user-files</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_TEMPLATE_FILES_BUCKET_NAME</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">overleaf-template-files</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_S3_ACCESS_KEY_ID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVERLEAF_FILESTORE_S3_ACCESS_KEY_ID</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_S3_SECRET_ACCESS_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OVERLEAF_FILESTORE_S3_SECRET_ACCESS_KEY</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_S3_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://198.18.0.5:9000</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_S3_PATH_STYLE</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="w">            </span><span class="nt">OVERLEAF_FILESTORE_S3_REGION</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span>

<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_BACKEND</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;s3&quot;</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_PROJECT_BLOBS_BUCKET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;overleaf-project-blobs&quot;</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_CHUNKS_BUCKET</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;overleaf-chunks&quot;</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_S3_ACCESS_KEY_ID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OVERLEAF_HISTORY_S3_ACCESS_KEY_ID&quot;</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_S3_SECRET_ACCESS_KEY</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;OVERLEAF_HISTORY_S3_SECRET_ACCESS_KEY&quot;</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_S3_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://198.18.0.5:9000</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_S3_PATH_STYLE</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="w">            </span><span class="nt">OVERLEAF_HISTORY_S3_REGION</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span>
<span class="w">            </span><span class="c1"># /S3</span>

<span class="w">            </span><span class="c1"># git-bridge</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_ENABLED</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git-bridge</span>
<span class="w">            </span><span class="nt">GIT_BRIDGE_PORT</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8000</span>
<span class="w">            </span><span class="c1"># Only needed on the sibling instance of git-bridge</span>
<span class="w">            </span><span class="nt">V1_HISTORY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://server-pro-ha-1:3100/api&quot;</span>
<span class="w">            </span><span class="c1"># /git-bridge</span>

<span class="w">            </span><span class="c1"># Horizontal scaling</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: pick secure credentials.</span>
<span class="w">            </span><span class="nt">WEB_API_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WEB_API_PASSWORD</span>
<span class="w">            </span><span class="nt">STAGING_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">V1_HISTORY_PASSWORD</span>
<span class="w">            </span><span class="nt">V1_HISTORY_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">V1_HISTORY_PASSWORD</span>
<span class="w">            </span><span class="nt">CRYPTO_RANDOM</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CRYPTO_RANDOM</span>
<span class="w">            </span><span class="nt">OT_JWT_AUTH_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OT_JWT_AUTH_KEY</span>
<span class="w">            </span><span class="nt">OVERLEAF_BEHIND_PROXY</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;true&#39;</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: IPs of load balancers</span>
<span class="w">            </span><span class="nt">TRUSTED_PROXY_IPS</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.1,198.18.0.2</span>
<span class="w">            </span><span class="c1"># /Horizontal scaling</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: run on host 198.18.1.1 and expose ports</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;80:80&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.1.1</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container on a separate host.</span>
<span class="w">    </span><span class="nt">server-pro-ha-2</span><span class="p">:</span>
<span class="w">        </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*server-pro-ha-config</span>
<span class="w">        </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-pro-ha-2</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-pro-ha-2</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/scratch-disk2:/var/lib/sharelatex</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*server-pro-ha-environment</span>
<span class="w">            </span><span class="nt">SANDBOXED_COMPILES_HOST_DIR</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/tmp/scratch-disk2/data/compiles&#39;</span>
<span class="w">            </span><span class="nt">V1_HISTORY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:3100/api&quot;</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: run on host 198.18.1.2 and expose ports</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;80:80&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.1.2</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container on a separate host.</span>
<span class="w">    </span><span class="nt">server-pro-ha-3</span><span class="p">:</span>
<span class="w">        </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*server-pro-ha-config</span>
<span class="w">        </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-pro-ha-3</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-pro-ha-3</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/scratch-disk3:/var/lib/sharelatex</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/run/docker.sock:/var/run/docker.sock</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="nt">&lt;&lt;</span><span class="p">:</span><span class="w"> </span><span class="nv">*server-pro-ha-environment</span>
<span class="w">            </span><span class="nt">SANDBOXED_COMPILES_HOST_DIR</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/tmp/scratch-disk3/data/compiles&#39;</span>
<span class="w">            </span><span class="nt">V1_HISTORY_URL</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:3100/api&quot;</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: run on host 198.18.1.3 and expose ports</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;80:80&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.1.3</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container on a separate host.</span>
<span class="w">    </span><span class="nt">minio</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minio/minio:RELEASE.2023-05-18T00-05-36Z</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minio</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server /data</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: run minio with multiple disks, see minio docs.</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/minio_data:/data</span>
<span class="w">        </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: pick secure credentials.</span>
<span class="w">            </span><span class="nt">MINIO_ROOT_USER</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MINIO_ROOT_USER</span>
<span class="w">            </span><span class="nt">MINIO_ROOT_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MINIO_ROOT_PASSWORD</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: run on host 198.18.0.5 and expose port</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;9000:9000&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.5</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this setup once on a separate host.</span>
<span class="w">    </span><span class="nt">minio_setup</span><span class="p">:</span>
<span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minio</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">minio/mc:RELEASE.2023-05-18T16-59-00Z</span>
<span class="w">        </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;-c&#39;</span>
<span class="w">            </span><span class="c1"># Actual horizontal scaling setup: pick secure credentials.</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">                </span><span class="no">mc alias set s3 http://198.18.0.5:9000 MINIO_ROOT_USER MINIO_ROOT_PASSWORD \</span>
<span class="w">                </span><span class="no">|| sleep 10 &amp;&amp; \</span>
<span class="w">                </span><span class="no">mc alias set s3 http://198.18.0.5:9000 MINIO_ROOT_USER MINIO_ROOT_PASSWORD \</span>
<span class="w">                </span><span class="no">|| sleep 10 &amp;&amp; \</span>
<span class="w">                </span><span class="no">mc alias set s3 http://198.18.0.5:9000 MINIO_ROOT_USER MINIO_ROOT_PASSWORD \</span>
<span class="w">                </span><span class="no">|| sleep 10 &amp;&amp; \</span>
<span class="w">                </span><span class="no">mc alias set s3 http://198.18.0.5:9000 MINIO_ROOT_USER MINIO_ROOT_PASSWORD</span>

<span class="w">                </span><span class="no">mc mb --ignore-existing s3/overleaf-user-files</span>
<span class="w">                </span><span class="no">mc mb --ignore-existing s3/overleaf-template-files</span>
<span class="w">                </span><span class="no">mc admin user add s3 \</span>
<span class="w">                  </span><span class="no">OVERLEAF_FILESTORE_S3_ACCESS_KEY_ID \</span>
<span class="w">                  </span><span class="no">OVERLEAF_FILESTORE_S3_SECRET_ACCESS_KEY</span>

<span class="w">                </span><span class="no">mc mb --ignore-existing s3/overleaf-project-blobs</span>
<span class="w">                </span><span class="no">mc mb --ignore-existing s3/overleaf-chunks</span>
<span class="w">                </span><span class="no">mc admin user add s3 \</span>
<span class="w">                  </span><span class="no">OVERLEAF_HISTORY_S3_ACCESS_KEY_ID \</span>
<span class="w">                  </span><span class="no">OVERLEAF_HISTORY_S3_SECRET_ACCESS_KEY</span>

<span class="w">                </span><span class="no">echo &#39;</span>
<span class="w">                  </span><span class="no">{</span>
<span class="w">                    </span><span class="no">&quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class="w">                    </span><span class="no">&quot;Statement&quot;: [</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:ListBucket&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-user-files&quot;</span>
<span class="w">                      </span><span class="no">},</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:PutObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:GetObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:DeleteObject&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-user-files/*&quot;</span>
<span class="w">                      </span><span class="no">},</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:ListBucket&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-template-files&quot;</span>
<span class="w">                      </span><span class="no">},</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:PutObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:GetObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:DeleteObject&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-template-files/*&quot;</span>
<span class="w">                      </span><span class="no">}</span>
<span class="w">                    </span><span class="no">]</span>
<span class="w">                  </span><span class="no">}&#39; &gt; policy-filestore.json</span>

<span class="w">                </span><span class="no">echo &#39;</span>
<span class="w">                  </span><span class="no">{</span>
<span class="w">                    </span><span class="no">&quot;Version&quot;: &quot;2012-10-17&quot;,</span>
<span class="w">                    </span><span class="no">&quot;Statement&quot;: [</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:ListBucket&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-project-blobs&quot;</span>
<span class="w">                      </span><span class="no">},</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:PutObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:GetObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:DeleteObject&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-project-blobs/*&quot;</span>
<span class="w">                      </span><span class="no">},</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:ListBucket&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-chunks&quot;</span>
<span class="w">                      </span><span class="no">},</span>
<span class="w">                      </span><span class="no">{</span>
<span class="w">                        </span><span class="no">&quot;Effect&quot;: &quot;Allow&quot;,</span>
<span class="w">                        </span><span class="no">&quot;Action&quot;: [</span>
<span class="w">                          </span><span class="no">&quot;s3:PutObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:GetObject&quot;,</span>
<span class="w">                          </span><span class="no">&quot;s3:DeleteObject&quot;</span>
<span class="w">                        </span><span class="no">],</span>
<span class="w">                        </span><span class="no">&quot;Resource&quot;: &quot;arn:aws:s3:::overleaf-chunks/*&quot;</span>
<span class="w">                      </span><span class="no">}</span>
<span class="w">                    </span><span class="no">]</span>
<span class="w">                  </span><span class="no">}&#39; &gt; policy-history.json</span>

<span class="w">                </span><span class="no"># Put the contents of the policy from the previous section in policy-filestore.json</span>
<span class="w">                </span><span class="no"># Reminder: Replace the bucket names accordingly.</span>
<span class="w">                </span><span class="no">mc admin policy create s3 overleaf-filestore policy-filestore.json</span>
<span class="w">                </span><span class="no">mc admin policy attach s3 overleaf-filestore \</span>
<span class="w">                  </span><span class="no">--user=OVERLEAF_FILESTORE_S3_ACCESS_KEY_ID || true</span>

<span class="w">                </span><span class="no">mc admin policy create s3 overleaf-history policy-history.json</span>
<span class="w">                </span><span class="no">mc admin policy attach s3 overleaf-history \</span>
<span class="w">                  </span><span class="no">--user=OVERLEAF_HISTORY_S3_ACCESS_KEY_ID || true</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container on a separate host.</span>
<span class="w">    </span><span class="nt">mongo</span><span class="p">:</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:4.4</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;--replSet</span><span class="nv"> </span><span class="s">overleaf&quot;</span>
<span class="w">        </span><span class="nt">expose</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/mongo_data:/data/db</span>
<span class="w">        </span><span class="nt">healthcheck</span><span class="p">:</span>
<span class="w">            </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo &#39;db.stats().ok&#39; | mongo localhost:27017/test --quiet</span>
<span class="w">            </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">            </span><span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10s</span>
<span class="w">            </span><span class="nt">retries</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: run on host 198.18.0.3 and expose port</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;27017:27017&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.3</span>

<span class="w">    </span><span class="nt">mongo_replica_set_setup</span><span class="p">:</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:4.4</span>
<span class="w">        </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sh</span>
<span class="w">        </span><span class="nt">depends_on</span><span class="p">:</span>
<span class="w">            </span><span class="nt">mongo</span><span class="p">:</span>
<span class="w">                </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">service_healthy</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;-c&#39;</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">                </span><span class="no">mongo 198.18.0.3 --eval &quot;rs.initiate({ _id: \&quot;overleaf\&quot;, members: [ { _id: 0, host: \&quot;198.18.0.3:27017\&quot; } ] })&quot;</span>

<span class="w">    </span><span class="c1"># Actual horizontal scaling setup: run this container on a separate host.</span>
<span class="w">    </span><span class="nt">redis</span><span class="p">:</span>
<span class="w">        </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis:6.2</span>
<span class="w">        </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redis</span>
<span class="w">        </span><span class="nt">expose</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6379</span>
<span class="w">        </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/redis_data:/data</span>

<span class="w">        </span><span class="c1"># Actual horizontal scaling setup: run on host 198.18.0.4 and expose port</span>
<span class="w">        </span><span class="c1"># ports:</span>
<span class="w">        </span><span class="c1">#     - &quot;6379:6379&quot;</span>
<span class="w">        </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">            </span><span class="nt">default</span><span class="p">:</span>
<span class="w">                </span><span class="nt">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">198.18.0.4</span>
</code></pre></div>
</details></p>
</li>
</ul>
<h3 id="hardware">Hardware<a class="headerlink" href="#hardware" title="Permanent link">&para;</a></h3>
<p>We recommend using the same hardware specifications for all the Server Pro instances that are taking part in horizontal scaling.</p>
<p>The general recommendations on <a href="https://github.com/overleaf/overleaf/wiki/Hardware-Requirements">hardware specifications for Server Pro instances</a> apply.</p>
<h3 id="upgrading-server-pro">Upgrading Server Pro<a class="headerlink" href="#upgrading-server-pro" title="Permanent link">&para;</a></h3>
<p>As part of the upgrade process, Server Pro is automatically running database migrations.These migrations are not designed to be run from multiple instances in parallel.</p>
<p>The migrations need to finish before the actual web application is started. You can either check the logs for an entry of <code>Finished migrations</code> or wait until the application accepts traffic.</p>
<p>The upgrade procedure looks like this:</p>
<ol>
<li>Schedule a maintenance window</li>
<li>Stop all the instances of Server Pro</li>
<li>Take a consistent backup as described <a href="https://github.com/overleaf/overleaf/wiki/Data-and-Backups">in the documentation</a></li>
<li>Start a single instance of Server Pro with the new version</li>
<li>Validate that the new instance is working as expected</li>
<li>Bring up the other instances with the new version</li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../s3-migration/" class="md-footer__link md-footer__link--prev" aria-label="Previous: S3 migration">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                S3 migration
              </div>
            </div>
          </a>
        
        
          
          <a href="../../guides/for-users/" class="md-footer__link md-footer__link--next" aria-label="Next: For users">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                For users
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.share", "navigation.tabs", "navigation.footer", "navigation.path", "navigation.top", "content.code.copy", "content.code.select", "content.code.annotate", "content.action.edit", "navigation.expand"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "tags": {"Server Pro": "server_pro"}, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>